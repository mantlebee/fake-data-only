import { Any, Dictionary, KeyOf, List } from "@mantlebee/ts-core";

import { Dataset, Row } from "./types";

/**
 * Represents the column of a table ({@link ITable}).
 * Its purpose is to generate a value for the row generated by the table.
 * @typeParam TRow - Type of the row.
 * @typeParam TValue - Type of the column's value.
 */
export interface IColumn<TRow extends Row, TValue = Any> {
  /**
   * Column's name. It must be unique for a {@link ITable}.
   */
  readonly name: KeyOf<TRow>;
  /**
   * Generates a value. The returned value is applied to the row.
   * @param row Row to update. The row has the values of the previous columns already processed.
   */
  getValue(row: TRow): TValue;
}

/**
 * Represents the column of a table ({@link ITable}), used to generate data based on values of rows from a different table.
 * Its purpose is to generate a default value for the row generated by the table, and to update it when target table's rows are generated.
 * @typeParam TRow - Type of the row.
 * @typeParam TTargetRow - Type of the row of the related table.
 * @typeParam TValue - Type of the column's value.
 */
export interface IColumnRelation<
  TRow extends Row,
  TTargetRow extends Row,
  TValue = Any,
> extends IColumn<TRow, TValue> {
  /**
   * Update source table rows using a target table rows or the entire dataset.
   * @param sourceRows List of rows to update of the source table.
   * @param targetRows List of rows of the target table.
   * @param dataset The entire database dataset.
   */
  setValues(
    sourceRows: List<TRow>,
    targetRows: List<TTargetRow>,
    dataset: Dataset
  ): void;
}

/**
 * Represents a database with its own tables ({@link ITable}) and relations {@link Relation}.
 * Its purpose is to generate the database dataset.
 * The {@link Dataset} object is a dictionary, where the keys are the tables names and the values are objects with the table instance and its generated rows.
 */
export interface IDatabase {
  /**
   * List of tables that must be used to generate rows.
   */
  readonly tables: List<ITable<Any>>;
  /**
   * Generates the database dataset, it is a dictionary, where the keys are the tables names and the values are objects with the table instance and its generated rows.
   * @param countsMap Dictionary with the tables counts, used to generate a specific amount of rows for each table. It is a dictionary where the keys are the tables names and the values the row counts to generate.
   */
  getDataset(countsMap: Dictionary<number>): Dataset;
}

/**
 * Represents a table.
 * Its purpose is to generate rows.
 * @typeParam TRow - Type of the row.
 */
export interface ITable<TRow extends Row> {
  /**
   * The table's columns used to generate values for the rows.
   */
  readonly columns: List<IColumn<TRow>>;
  /**
   * Table's name.
   */
  readonly name: string;
  /**
   * Generates a specific amount of rows.
   * @param count Number of rows to generate.
   */
  getRows(count: number): List<TRow>;
}
